### Serverless 概念
通常意义上来讲，Serverless 可以看作是一种云计算服务模型，它允许开发者在不需要管理服务器的情况下通过事件驱动的方式运行代码。与传统应用服务开发模式不同，开发者只需编写并上传他们的应用代码到云服务商提供的平台上，云平台会自动为应用分配资源，并处理应用的部署、扩缩容。这使得开发者可以更加专注于自己的业务需求和应用逻辑，而不需要考虑服务资源的申请、创建、管理和维护等。从这个意义上讲，我们也可以认为Serverless是一个计算范式，它解决资源托管、调度、运维管理等一系列平台型问题，可以看作是DevOps的进一步延伸。

从应用开发视角来看，Serverless包括FaaS (Function as a Service) 和 BaaS (Backend as a Service) 两部分。在FaaS中，开发者编写的代码会被封装成一个或多个函数，运行在云平台上。当请求到达时，云平台自动为函数分配计算资源，拉起函数并执行。执行完成后，平台根据一定的保活策略决定资源的复用或者释放。FaaS模型不仅可以提高应用的可伸缩性和弹性，还可以大幅降低应用运维的成本。BaaS则致力于更广泛意义下的Serverless化，包括对象存储、缓存、数据库、消息等全栈后端服务的按需弹性、按用付费等。

Serverless，它是云计算发展过程中出现的一种计算资源的抽象，依赖第三方服务，开发者可以更加专注的开发自己的业务代码，而无需关心底层资源的分配、扩容和部署。

特点：

1. 开发者只需要专注于业务，无需关心底层资源的分配、扩容和部署
2. 按需使用和收费
3. 自动扩缩容

### Serverless + SSR

结合 Serverless 和 [[服务端渲染（SSR）]] 的特点，我们可以发现他们简直是天作之合。借助 Serverless，前端团队无需关注 SSR 服务器的部署、运维和扩容，可以极大地减少部署运维成本，更好的聚焦业务开发，提高开发效率。

同时也无需关心 SSR 服务器的性能问题，理论上 Serverless 是可以无限扩容的（当然云厂商对于一般用户是有扩容上限的）。

### 如何快速将 SSR 应用 Serverless 化？

既然说 Serverless 对于 SSR 来说有天然的优势，那么我们如何将 SSR 应用迁移到Serverless 架构上呢？

本文将以 Next.js 框架为例，带大家快速体验部署一个 Serverless SSR 应用。

#### Serverless + Next.js 部署流程图

优化后项目整体部署流程图如下：

![[Pasted image 20240219160017.png]]

### Serverless 和 服务器方案 对比分析

从单用户访问页面性能表现来看 `Serverless 方案略逊于服务器方案`，但是页面性能指标是可以优化的。从压测来看，虽然 Serverless 的 `平均响应时间` 略大于 CVM，但是 `最大响应时间` 和 `P95耗时` 均优于 CVM 很多，CVM 的最大响应时间甚至接近 Serverless 的 `3倍`。而且当并发量逐渐增大时，CVM 的响应时间变化明显，而且越来越大，而 Serverless 则表现平稳，除了极个别的冷启动，基本能在 `200ms` 以内。

由此可以看出，随着并发的增加，SSR 会导致服务器负荷越来越大，从而会加大服务器的响应时间；而 Serverless 由于具有自动扩缩的能力，所以相对比较平稳。

当然由于测试条件有限，可能会有考虑不够全面的地方，但是从压测图形来看，是完全符合理论预期的。

但是从价格对比来看，接近配置的 Serverless 方案基本不怎么花钱，甚至很多时候，免费额度就已经可以满足需求了，这里为了增加 Serverless 费用，估计调大了调用次数，内存大小，但是即便如此，服务器方案还是接近 Serverless 方案的 10 倍!!!!!。

### Serverless的技术特点

为了实现解耦应用和服务器资源，实现服务器资源对用户透明，与传统架构相比，Serverless 架构在技术上有许多不同的特点。

- 1.按需加载

在 Serverless 架构下，应用的加载（load）和卸载（unload）由 Serverless 云计算平台控制。这意味着应用不总是一直在线的。只有当有请求到达或者有事件发生时才会被部署和启动。当应用空闲至一定时长时，应用会到达或者有事件发生时才会被部署和启动。当应用空闲至一定时长时，应用会被自动停止和卸载。因此应用并不会持续在线，不会持续占用计算资源。

- 2.事件驱动

Serverless 架构的应用并不总是一直在线，而是按需加载执行。应用的加载和执行由事件驱动，比如HTTP请求到达、消息队列接收到新的信息或存储服务的文件被修改了等。通过将不同事件来源（Event Source）的事件（Event）与特定的函数进行关联，实现对不同事件采取不同的反应动作，这样可以非常容易地实现事件驱动（Event Driven）架构。

- 3.状态非本地持久化

云计算平台自动控制应用实例的加载和卸载，且应用和服务器完全解耦，应用不再与特定的服务器关联。因此应用的状态不能，也不会保存在其运行的服务器之上，不能做到传统意义上的状态本地持久化。

- 4.非会话保持

应用不再与特定的服务器关联。每次处理请求的应用实例可能是相同服务器上的应用实例，也可能是新生成的服务器上的应用实例。因此，用户无法保证同一客户端的两次请求由同一个服务器上的同一个应用实例来处理。也就是说，无法做到传统意义上的会话保持（Sticky Session）。因此，Serverless架构更适合无状态的应用。

- 5.自动弹性伸缩

Serverless 应用原生可以支持高可用，可以应对突发的高访问量。应用实例数量根据实际的访问量由云计算平台进行弹性的自动扩展或收缩，云计算平台动态地保证有足够的计算资源和足够数量的应用实例对请求进行处理。

- 6.应用函数化

每一个调用完成一个业务动作，应用会被分解成多个细颗粒度的操作。由于状态无法本地持久化，这些细颗粒度的操作是无状态的，类似于传统编程里无状态的函数。Serverless 架构下的应用会被函数化，但不能说 Serverless 就是 Function as a Service（FaaS）。Serverless 涵盖了 FaaS 的一些特性，可以说 FaaS 是 Serverless 架构实现的一个重要手段。

### Serverless的应用场景

通过将 Serverless 的理念与当前 Serverless 实现的技术特点相结合，Serverless 架构可以适用于各种业务场景。

- 1.Web应用

Serverless 架构可以很好地支持各类静态和动态Web应用。如 RESTful API 的各类请求动作（GET、POST、PUT及DELETE等）可以很好地映射成 FaaS 的一个个函数，功能和函数之间能建立良好的对应关系。通过 FaaS 的自动弹性扩展功能，Serverless Web 应用可以很快速地构建出能承载高访问量的站点。

- 2.移动互联网

Serverless 应用通过 BaaS 对接后端不同的服务而满足业务需求，提高应用开发的效率。前端通过FaaS提供的自动弹性扩展对接移动端的流量，开发者可以更轻松地应对突发的流量增长。在 FaaS 的架构下，应用以函数的形式存在。各个函数逻辑之间相对独立，应用更新变得更容易，使新功能的开发、测试和上线的时间更短。

- 3.物联网（Internet of Things，IoT）

物联网（Internet of Things，IoT）应用需要对接各种不同的数量庞大的设备。不同的设备需要持续采集并传送数据至服务端。Serverless 架构可以帮助物联网应用对接不同的数据输入源。

- 4.多媒体处理

视频和图片网站需要对用户上传的图片和视频信息进行加工和转换。但是这种多媒体转换的工作并不是无时无刻都在进行的，只有在一些特定事件发生时才需要被执行，比如用户上传或编辑图片和视频时。通过 Serverless 的事件驱动机制，用户可以在特定事件发生时触发处理逻辑，从而节省了空闲时段计算资源的开销，最终降低了运维的成本。

- 5.数据及事件流处理

Serverless 可以用于对一些持续不断的事件流和数据流进行实时分析和处理，对事件和数据进行实时的过滤、转换和分析，进而触发下一步的处理。比如，对各类系统的日志或社交媒体信息进行实时分析，针对符合特定特征的关键信息进行记录和告警。

- 6.系统集成

Serverless 应用的函数式架构非常适合用于实现系统集成。用户无须像过去一样为了某些简单的集成逻辑而开发和运维一个完整的应用，用户可以更专注于所需的集成逻辑，只编写和集成相关的代码逻辑，而不是一个完整的应用。函数应用的分散式的架构，使得集成逻辑的新增和变更更加灵活。



### 最后

作为一名前端开发，内心是无比激动的。记得以前在项目中为了优化首屏时间和 SEO，就做个好几个方案的对比，但是最终因为公司运维团队的不够配合，最后放弃了 [[服务端渲染（SSR）]]，最后选择了前端可掌控的 `预渲染方案`。现在有了 Serverless，前端终于不用受运维的限制，可以基于 Serverless 来大胆的尝试 SSR。而且借助 Serverless，前端还可以做的更多。

当然真正的 SSR 并不止如此，要达到页面极致体验我们还需要做很多工作，比如：

1. 静态资源部署到 CDN
2. 页面缓存
3. 降级处理
4. ...

但是这些无论是部署到服务器还是 Serverless，都是我们需要做的工作。并不会成为我们将 SSR 部署到 Serverless 的绊脚石。